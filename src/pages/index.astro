---
import Layout from '../layouts/Layout.astro';
import type { Language } from '@/lib/translations';

// React Islands (interactive components)
import Navigation from '../components/islands/Navigation';
import HeroSection from '../components/islands/HeroSection';
import GiftSection from '../components/islands/GiftSection';
import PricingSection from '../components/islands/PricingSection';
import FAQSection from '../components/islands/FAQSection';
import MembershipModal from '../components/islands/MembershipModal';

// Static Astro Sections (zero JS)
import StudioSection from '../components/sections/StudioSection.astro';
import ClassesSection from '../components/sections/ClassesSection.astro';
import AppSection from '../components/sections/AppSection.astro';
import LocationSection from '../components/sections/LocationSection.astro';
import CTASection from '../components/sections/CTASection.astro';
import Footer from '../components/sections/Footer.astro';

// Read language from cookie, default to 'en'
const langCookie = Astro.cookies.get('pilatopia-lang');
const lang: Language = (langCookie?.value === 'ar' ? 'ar' : 'en') as Language;
---

<Layout lang={lang}>
  <main>
    <!-- Navigation: client:load for immediate interactivity (language toggle, mobile menu) -->
    <Navigation client:load lang={lang} />

    <!-- Hero: client:load for immediate animations and class carousel -->
    <div id="hero" data-section="Hero">
      <HeroSection client:load lang={lang} />
    </div>

    <!-- Gift Section: client:visible (has occasion rotation animation) -->
    <div id="gift" data-section="Gift">
      <GiftSection client:visible lang={lang} />
    </div>

    <!-- Studio Gallery: Static Astro (no JS needed) -->
    <div id="studio" data-section="Studio">
      <StudioSection lang={lang} />
    </div>

    <!-- Pricing: client:visible (has collapsible packages) -->
    <div id="pricing" data-section="Pricing">
      <PricingSection client:visible lang={lang} />
    </div>

    <!-- App Section: Static Astro (no JS needed) -->
    <div id="mobile-app" data-section="Mobile App">
      <AppSection lang={lang} />
    </div>

    <!-- Location: Static Astro (Google Maps embed, no JS needed) -->
    <div id="location" data-section="Location">
      <LocationSection lang={lang} />
    </div>

    <!-- CTA: Static Astro (no JS needed) -->
    <div id="cta" data-section="CTA">
      <CTASection lang={lang} />
    </div>

    <!-- Classes: Static Astro (no JS needed) -->
    <div id="classes" data-section="Classes">
      <ClassesSection lang={lang} />
    </div>

    <!-- FAQ: client:visible (has accordion) -->
    <div id="faq" data-section="FAQ">
      <FAQSection client:visible lang={lang} />
    </div>

    <!-- Footer: Static Astro (no JS needed) -->
    <Footer lang={lang} />

    <!-- Membership Modal: client:idle (only hydrate when browser is idle) -->
    <MembershipModal client:idle lang={lang} />
  </main>

  <!-- Analytics Tracking -->
  <script is:inline>
    (function() {
      // Section View Tracking
      const trackedSections = new Set();

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const sectionName = entry.target.dataset.section;
            const sectionId = entry.target.id;

            if (sectionName && !trackedSections.has(sectionId)) {
              trackedSections.add(sectionId);

              if (typeof gtag === 'function') {
                gtag('event', 'section_view', {
                  section_name: sectionName,
                  section_id: sectionId
                });
              }
            }
          }
        });
      }, {
        threshold: 0.5
      });

      document.querySelectorAll('[data-section]').forEach((section) => {
        observer.observe(section);
      });

      // Outbound Link Click Tracking
      document.addEventListener('click', function(e) {
        const link = e.target.closest('a[href]');
        if (!link) return;

        const href = link.href;
        if (typeof gtag !== 'function') return;

        // WhatsApp clicks
        if (href.includes('wa.me') || href.includes('whatsapp.com')) {
          gtag('event', 'whatsapp_click', {
            link_url: href,
            link_location: link.closest('[data-section]')?.dataset.section || 'unknown'
          });
        }

        // App Store clicks
        if (href.includes('apps.apple.com')) {
          gtag('event', 'app_store_click', {
            link_url: href,
            link_location: link.closest('[data-section]')?.dataset.section || 'unknown'
          });
        }

        // Google Maps clicks
        if (href.includes('google.com/maps') || href.includes('maps.app.goo.gl')) {
          gtag('event', 'maps_click', {
            link_url: href,
            link_location: link.closest('[data-section]')?.dataset.section || 'unknown'
          });
        }

        // Phone calls
        if (href.startsWith('tel:')) {
          gtag('event', 'phone_click', {
            phone_number: href.replace('tel:', ''),
            link_location: link.closest('[data-section]')?.dataset.section || 'unknown'
          });
        }

        // Email clicks
        if (href.startsWith('mailto:')) {
          gtag('event', 'email_click', {
            email_address: href.replace('mailto:', ''),
            link_location: link.closest('[data-section]')?.dataset.section || 'unknown'
          });
        }
      });
    })();
  </script>
</Layout>

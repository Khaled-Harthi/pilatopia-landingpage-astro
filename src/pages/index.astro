---
import Layout from '../layouts/Layout.astro';
import type { Language } from '@/lib/translations';

// React Islands (interactive components)
import Navigation from '../components/islands/Navigation';
import HeroSection from '../components/islands/HeroSection';
import GiftSection from '../components/islands/GiftSection';
import PricingSection from '../components/islands/PricingSection';
import FAQSection from '../components/islands/FAQSection';
import MembershipModal from '../components/islands/MembershipModal';

// Static Astro Sections (zero JS)
import StudioSection from '../components/sections/StudioSection.astro';
import ClassesSection from '../components/sections/ClassesSection.astro';
import AppSection from '../components/sections/AppSection.astro';
import LocationSection from '../components/sections/LocationSection.astro';
import CTASection from '../components/sections/CTASection.astro';
import Footer from '../components/sections/Footer.astro';

// Read language from cookie, default to 'en'
const langCookie = Astro.cookies.get('pilatopia-lang');
const lang: Language = (langCookie?.value === 'ar' ? 'ar' : 'en') as Language;
---

<Layout lang={lang}>
  <main>
    <!-- Navigation: client:load for immediate interactivity (language toggle, mobile menu) -->
    <Navigation client:load lang={lang} />

    <!-- Hero: client:load for immediate animations and class carousel -->
    <div id="hero" data-section="Hero">
      <HeroSection client:load lang={lang} />
    </div>

    <!-- Gift Section: client:visible (has occasion rotation animation) -->
    <div id="gift" data-section="Gift">
      <GiftSection client:visible lang={lang} />
    </div>

    <!-- Studio Gallery: Static Astro (no JS needed) -->
    <div id="studio" data-section="Studio">
      <StudioSection lang={lang} />
    </div>

    <!-- Pricing: client:visible (has collapsible packages) -->
    <div id="pricing" data-section="Pricing">
      <PricingSection client:visible lang={lang} />
    </div>

    <!-- App Section: Static Astro (no JS needed) -->
    <div id="mobile-app" data-section="Mobile App">
      <AppSection lang={lang} />
    </div>

    <!-- Location: Static Astro (Google Maps embed, no JS needed) -->
    <div id="location" data-section="Location">
      <LocationSection lang={lang} />
    </div>

    <!-- CTA: Static Astro (no JS needed) -->
    <div id="cta" data-section="CTA">
      <CTASection lang={lang} />
    </div>

    <!-- Classes: Static Astro (no JS needed) -->
    <div id="classes" data-section="Classes">
      <ClassesSection lang={lang} />
    </div>

    <!-- FAQ: client:visible (has accordion) -->
    <div id="faq" data-section="FAQ">
      <FAQSection client:visible lang={lang} />
    </div>

    <!-- Footer: Static Astro (no JS needed) -->
    <Footer lang={lang} />

    <!-- Membership Modal: client:idle (only hydrate when browser is idle) -->
    <MembershipModal client:idle lang={lang} />
  </main>

  <!-- Section View Tracking -->
  <script is:inline>
    (function() {
      const trackedSections = new Set();

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const sectionName = entry.target.dataset.section;
            const sectionId = entry.target.id;

            // Only track each section once per page load
            if (sectionName && !trackedSections.has(sectionId)) {
              trackedSections.add(sectionId);

              // Send to GA4
              if (typeof gtag === 'function') {
                gtag('event', 'section_view', {
                  section_name: sectionName,
                  section_id: sectionId
                });
              }
            }
          }
        });
      }, {
        threshold: 0.5 // Trigger when 50% of section is visible
      });

      // Observe all sections with data-section attribute
      document.querySelectorAll('[data-section]').forEach((section) => {
        observer.observe(section);
      });
    })();
  </script>
</Layout>
